<!doctype html><html lang=en class="wf-firasans-n4-active wf-active"><head><link href=http://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=generator content="Hugo 0.121.0"><title>Implementing CQRS with MediatR - Part 4 &#183; Moien Tajik</title>
<meta content="Moien Tajik" property="og:site_name"><meta content="Implementing CQRS with MediatR - Part 4 - Moien Tajik" property="og:title"><meta content="This series explores the implementation of the CQRS design pattern using the MediatR library." property="og:description"><meta content="/dry.png" property="og:image"><link href="https://fonts.googleapis.com/css?family=Fira+Sans:300,300i,400,400i|Roboto+Mono:300,300i,400,400i" rel=stylesheet><style media=print>.sidebar{display:none!important}.container,.content{width:100%;float:none;display:initial;margin:0 auto}.container{padding-left:1rem;padding-right:1rem}</style><link rel=stylesheet href=/css/poole.css><link rel=stylesheet href=/css/hyde.css><link rel=stylesheet href=/css/custom.css><script defer src=https://use.fontawesome.com/releases/v5.0.13/js/all.js integrity=sha384-xymdQtn1n3lH2wcu0qhcdaOpQwyoarkgLVxC/wZ5q7h9gHtxICrpcaSUfygqZGOe crossorigin=anonymous></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body class=theme-base-te><div class=sidebar><div class="container text-center"><div class="sidebar-about text-center"><img src=/img/Moien%20Tajik.png alt="Moien Tajik's Image" class="img-circle headshot center">
<a href=/ class=no-decoration><h1 class=brand>Moien Tajik</h1></a><p class=lead>Principal Software Engineer</p></div><div><ul class=sidebar-nav><li><a href=/><span>Home</span></a></li><li><a href=/posts/><span>Posts</span></a></li><li><a href=/tags/><span>Tags</span></a></li></li></ul></div><p><section class="row text-center"><a href=https://twitter.com/MoienTajik><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a>
&nbsp;<a href=https://github.com/MoienTajik><i class="fab fa-github fa-lg" aria-hidden=true></i></a>
&nbsp;<a href=https://linkedin.com/in/MoienTajik><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a>
&nbsp;<a href=https://stackoverflow.com/story/moientajik><i class="fab fa-stack-overflow fa-lg" aria-hidden=true></i></a>
&nbsp;<a href=https://medium.com/@MoienTajik><i class="fab fa-medium fa-lg" aria-hidden=true></i></a>
&nbsp;<a href=mailto:moientajik@hotmail.com><i class="fas fa-at fa-lg" aria-hidden=true></i></a></section></p><p class=copyright>&copy; 2024 Moien Tajik</br><a href=https://creativecommons.org/licenses/by/4.0>All rights reserved</a></p></div><div></div></div><div class="content container"><div class=post><h1 class=postTitle>Implementing CQRS with MediatR - Part 4</h1><div class="col-sm-12 col-md-12"><span class="text-left post-date meta"><i class="fas fa-calendar-alt"></i> <span class=subtitle>Publish Date: Feb 11, 2019</span><br><i class="fas fa-tags"></i>
Tags:
<a class=meta href=/tags/cqrs>cqrs</a>
,
<a class=meta href=/tags/designpatterns>designpatterns</a>
,
<a class=meta href=/tags/eventsourcing>eventsourcing</a>
,
<a class=meta href=/tags/mediator>mediator</a>
,
<a class=meta href=/tags/mediatr>mediatr</a><br></span></div><hr><p>In this part, we aim to explore <a href=https://github.com/jbogard/MediatR/wiki/Behaviors>Behaviors</a> in the MediatR framework. The code for this part is updated and accessible from this <a href=https://github.com/MoienTajik/MediatrTutorial>repository</a>.</p><p>Behaviors enables effortless implementation of <a href=https://www.dotnettips.info/courses/details/4>AOP (Aspect-Oriented Programming)</a>. Behaviors are analogous to <a href="https://docs.microsoft.com/en-us/aspnet/core/mvc/controllers/filters?view=aspnetcore-2.2#implementation">Filters</a> in ASP.NET Core. Just like how <code>OnActionExecuting</code> and <code>OnActionExecuted</code> methods let us perform actions before and after the execution of an action method, behaviors in MediatR offer a similar capability. The advantage is that you can write your cross-cutting concern code <strong>once</strong> and reuse it <strong>multiple times</strong> without redundancy.</p><hr><h3 id=performance-counter-behavior>Performance Counter Behavior</h3><p>Imagine you want to measure the execution time of a method and log a message if it exceeds an acceptable duration. The first approach that may come to mind is to repetitively insert similar code snippets in <strong>all</strong> methods requiring time measurement.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SomeClass</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> ILogger _logger;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> SomeClass(ILogger logger)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        _logger = logger;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> SomeMethod()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        Stopwatch stopwatch = <span style=color:#66d9ef>new</span> Stopwatch();
</span></span><span style=display:flex><span>        stopwatch.Start();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// TODO: Do some work here</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        stopwatch.Stop();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (stopwatch.ElapsedMilliseconds &gt; TimeSpan.FromSeconds(<span style=color:#ae81ff>5</span>).Milliseconds)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// This method has taken a long time, So we log that to check it later.</span>
</span></span><span style=display:flex><span>            _logger.LogWarning(<span style=color:#e6db74>$&#34;SomeClass.SomeMethod has taken {stopwatch.ElapsedMilliseconds} to run completely !&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=custom-linebreak></div><p>With this approach, all methods requiring time calculation would need a logger injected into their class. A Stopwatch must be created, started, and stopped, and finally, we must evaluate whether the execution time exceeds the predetermined limit.</p><p>Moreover, imagine deciding one day to change the maximum time for logging from 5 seconds to 10 seconds. Because the snippet is repeated across all methods, you will have to modify the entire codebase, violating the <a href=https://deviq.com/don-t-repeat-yourself>DRY (Donâ€™t Repeat Yourself) principle</a>.</p><p><img src=/posts/2019-02-11-mediatr-part-4/dry.png width=400px class=post-image><div class=custom-linebreak></div></p><p>To solve this issue, we use <em>Behaviors</em>. Implementing Behaviors in MediatR merely involves inheriting from an interface called <code>IPipelineBehavior</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RequestPerformanceBehavior</span>&lt;TRequest, TResponse&gt; :
</span></span><span style=display:flex><span>    IPipelineBehavior&lt;TRequest, TResponse&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> ILogger&lt;RequestPerformanceBehavior&lt;TRequest, TResponse&gt;&gt; _logger;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> RequestPerformanceBehavior(ILogger&lt;RequestPerformanceBehavior&lt;TRequest, TResponse&gt;&gt; logger)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        _logger = logger;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task&lt;TResponse&gt; Handle(TRequest request, CancellationToken cancellationToken, RequestHandlerDelegate&lt;TResponse&gt; next)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        Stopwatch stopwatch = <span style=color:#66d9ef>new</span> Stopwatch();
</span></span><span style=display:flex><span>        stopwatch.Start();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        TResponse response = <span style=color:#66d9ef>await</span> next();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        stopwatch.Stop();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (stopwatch.ElapsedMilliseconds &gt; TimeSpan.FromSeconds(<span style=color:#ae81ff>5</span>).Milliseconds)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// This method has taken a long time, So we log that to check it later.</span>
</span></span><span style=display:flex><span>            _logger.LogWarning(<span style=color:#e6db74>$&#34;{request} has taken {stopwatch.ElapsedMilliseconds} to run completely !&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> response;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=custom-linebreak></div><p>As you can see, the logic of our code remains unchanged. We inherit from <code>IPipelineBehavior</code> and implement its <code>Handle</code> method. Like <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/middleware/?view=aspnetcore-2.2#write-middleware">Middleware</a> in ASP.NET Core, we also have a <code>RequestHandlerDelegate</code> called <code>next</code>. By executing and returning it, the remaining Command/Query execution continues.</p><p>We then register our custom Behaviors via DI in <code>Startup.cs</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span>services.AddScoped(<span style=color:#66d9ef>typeof</span>(IPipelineBehavior&lt;,&gt;), <span style=color:#66d9ef>typeof</span>(RequestPerformanceBehavior&lt;,&gt;));
</span></span></code></pre></div><p><div class=custom-linebreak></div>Finally, to test the functionality of this Behavior, we introduce a 5-second delay in our <code>GetCustomerByIdQueryHandler</code> to make the execution time exceed the specified maximum time for logging:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>GetCustomerByIdQueryHandler</span> : IRequestHandler&lt;GetCustomerByIdQuery, CustomerDto&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> ApplicationDbContext _context;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> IMapper _mapper;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> GetCustomerByIdQueryHandler(ApplicationDbContext context, IMapper mapper)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        _context = context;
</span></span><span style=display:flex><span>        _mapper = mapper;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task&lt;CustomerDto&gt; Handle(GetCustomerByIdQuery request, CancellationToken cancellationToken)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        Customer customer = <span style=color:#66d9ef>await</span> _context.Customers
</span></span><span style=display:flex><span>            .FindAsync(request.CustomerId);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (customer == <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RestException(HttpStatusCode.NotFound, <span style=color:#e6db74>&#34;Customer with given ID is not found.&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// For testing PerformanceBehavior</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> Task.Delay(<span style=color:#ae81ff>5000</span>, cancellationToken);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> _mapper.Map&lt;CustomerDto&gt;(customer);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><div class=custom-linebreak></div>After running the application and invoking <code>GetCustomerById</code>, you will see the following message in the console:</p><p><img src=/posts/2019-02-11-mediatr-part-4/delay.png width class=post-image><div class=custom-linebreak></div></p><hr><h3 id=transaction-behavior>Transaction Behavior</h3><p><div class=custom-linebreak></div><img src=/posts/2019-02-11-mediatr-part-4/rollback.png width=400px class=post-image><div class=custom-linebreak></div></p><p>Another usage for Behaviors could be implementing Transactions and Rollbacks. Imagine you want to add a customer to the database only if all tasks within the Command are successfully completed without throwing any exceptions. We can write a <code>TransactionBehavior</code> to wrap the Command bodies within a <code>TransactionScope</code> and roll back in case of an exception:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TransactionBehavior</span>&lt;TRequest, TResponse&gt; :
</span></span><span style=display:flex><span>    IPipelineBehavior&lt;TRequest, TResponse&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task&lt;TResponse&gt; Handle(TRequest request, CancellationToken cancellationToken, RequestHandlerDelegate&lt;TResponse&gt; next)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> transactionOptions = <span style=color:#66d9ef>new</span> TransactionOptions
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            IsolationLevel = IsolationLevel.ReadCommitted,
</span></span><span style=display:flex><span>            Timeout = TransactionManager.MaximumTimeout
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>using</span> (<span style=color:#66d9ef>var</span> transaction = <span style=color:#66d9ef>new</span> TransactionScope(TransactionScopeOption.Required, transactionOptions,
</span></span><span style=display:flex><span>            TransactionScopeAsyncFlowOption.Enabled))
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            TResponse response = <span style=color:#66d9ef>await</span> next();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            transaction.Complete();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> response;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><div class=custom-linebreak></div>This <code>Behavior</code> is then registered in our DI container:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span>services.AddScoped(<span style=color:#66d9ef>typeof</span>(IPipelineBehavior&lt;,&gt;), <span style=color:#66d9ef>typeof</span>(TransactionBehavior&lt;,&gt;));
</span></span></code></pre></div><p><div class=custom-linebreak></div>Finally, we modify the <code>Handle</code> method in <code>CreateCustomerCommandHandler</code> that we created in the previous sections. After the <code>SaveChanges</code> related to EF-Core, we throw an Exception.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CreateCustomerCommandHandler</span> : IRequestHandler&lt;CreateCustomerCommand, CustomerDto&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>readonly</span> ApplicationDbContext _context;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>readonly</span> IMapper _mapper;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>readonly</span> IMediator _mediator;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> CreateCustomerCommandHandler(ApplicationDbContext context,
</span></span><span style=display:flex><span>        IMapper mapper,
</span></span><span style=display:flex><span>        IMediator mediator)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        _context = context;
</span></span><span style=display:flex><span>        _mapper = mapper;
</span></span><span style=display:flex><span>        _mediator = mediator;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task&lt;CustomerDto&gt; Handle(CreateCustomerCommand createCustomerCommand, CancellationToken cancellationToken)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        Domain.Customer customer = _mapper.Map&lt;Domain.Customer&gt;(createCustomerCommand);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> _context.Customers.AddAsync(customer, cancellationToken);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> _context.SaveChangesAsync(cancellationToken);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Exception(<span style=color:#e6db74>&#34;======= MY CUSTOM EXCEPTION =======&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Raising Event ...</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> _mediator.Publish(<span style=color:#66d9ef>new</span> CustomerCreatedEvent(customer.FirstName, customer.LastName, customer.RegistrationDate), cancellationToken);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> _mapper.Map&lt;CustomerDto&gt;(customer);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><div class=custom-linebreak></div>If you run the application, you will see that even though our exception occurs after <code>SaveChanges</code>, the operation is rolled back due to the Transaction Behavior we&rsquo;ve written, and no record is registered in the database.</p><p><strong>Note:</strong> Before utilizing Transactions, make sure to read these articles (<a href=https://blogs.msdn.microsoft.com/dbrowne/2010/06/03/using-new-transactionscope-considered-harmful>1</a>, <a href=https://particular.net/blog/transactionscope-and-async-await-be-one-with-the-flow>2</a>).</p><hr><p>MediatR also provides two interfaces, <code>IRequestPreProcessor</code> and <code>IRequestPostProcessor</code>, which you can use if you need an action to take place before or after the execution of a Command/Query.</p><p>Furthermore, default implementations of these two interfaces, named <code>RequestPreProcessorBehavior</code> and <code>RequestPostProcessorBehavior</code>, exist in the framework and will be executed before and after all handlers by <a href=https://github.com/jbogard/MediatR/wiki/Behaviors#built-in-behaviors>default</a>.</p></div><hr><div class=footer><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script type=text/javascript>hljs.configure({languages:[]}),hljs.initHighlightingOnLoad()</script><h2>Comments</h2><div id=disqus_thread></div><script type=text/javascript>(function(){if(location.hostname==="localhost"||location.hostname==="127.0.0.1"||location.hostname==="")return;var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="moientajik",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></div></body></html>