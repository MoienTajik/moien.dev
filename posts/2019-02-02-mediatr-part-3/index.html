<!doctype html><html lang=en class="wf-firasans-n4-active wf-active"><head><link href=http://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=generator content="Hugo 0.121.0"><title>Implementing CQRS with MediatR - Part 3 &#183; Moien Tajik</title>
<meta content="Moien Tajik" property="og:site_name"><meta content="Implementing CQRS with MediatR - Part 3 - Moien Tajik" property="og:title"><meta content="This series explores the implementation of the CQRS design pattern using the MediatR library." property="og:description"><meta content="/PubSub.jpg" property="og:image"><link href="https://fonts.googleapis.com/css?family=Fira+Sans:300,300i,400,400i|Roboto+Mono:300,300i,400,400i" rel=stylesheet><style media=print>.sidebar{display:none!important}.container,.content{width:100%;float:none;display:initial;margin:0 auto}.container{padding-left:1rem;padding-right:1rem}</style><link rel=stylesheet href=/css/poole.css><link rel=stylesheet href=/css/hyde.css><link rel=stylesheet href=/css/custom.css><script defer src=https://use.fontawesome.com/releases/v5.0.13/js/all.js integrity=sha384-xymdQtn1n3lH2wcu0qhcdaOpQwyoarkgLVxC/wZ5q7h9gHtxICrpcaSUfygqZGOe crossorigin=anonymous></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body class=theme-base-te><div class=sidebar><div class="container text-center"><div class="sidebar-about text-center"><img src=/img/Moien%20Tajik.png alt="Moien Tajik's Image" class="img-circle headshot center">
<a href=/ class=no-decoration><h1 class=brand>Moien Tajik</h1></a><p class=lead>Principal Software Engineer</p></div><div><ul class=sidebar-nav><li><a href=/><span>Home</span></a></li><li><a href=/posts/><span>Posts</span></a></li><li><a href=/tags/><span>Tags</span></a></li></li></ul></div><p><section class="row text-center"><a href=https://twitter.com/MoienTajik><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a>
&nbsp;<a href=https://github.com/MoienTajik><i class="fab fa-github fa-lg" aria-hidden=true></i></a>
&nbsp;<a href=https://linkedin.com/in/MoienTajik><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a>
&nbsp;<a href=https://stackoverflow.com/story/moientajik><i class="fab fa-stack-overflow fa-lg" aria-hidden=true></i></a>
&nbsp;<a href=https://medium.com/@MoienTajik><i class="fab fa-medium fa-lg" aria-hidden=true></i></a>
&nbsp;<a href=mailto:moientajik@hotmail.com><i class="fas fa-at fa-lg" aria-hidden=true></i></a></section></p><p class=copyright>&copy; 2024 Moien Tajik</br><a href=https://creativecommons.org/licenses/by/4.0>All rights reserved</a></p></div><div></div></div><div class="content container"><div class=post><h1 class=postTitle>Implementing CQRS with MediatR - Part 3</h1><div class="col-sm-12 col-md-12"><span class="text-left post-date meta"><i class="fas fa-calendar-alt"></i> <span class=subtitle>Publish Date: Feb 2, 2019</span><br><i class="fas fa-tags"></i>
Tags:
<a class=meta href=/tags/cqrs>cqrs</a>
,
<a class=meta href=/tags/designpatterns>designpatterns</a>
,
<a class=meta href=/tags/eventsourcing>eventsourcing</a>
,
<a class=meta href=/tags/mediator>mediator</a>
,
<a class=meta href=/tags/mediatr>mediatr</a><br></span></div><hr><p>In the <a href=https://moien.dev/posts/2019-01-27-mediatr-part-2>previous post</a>, we examined how to use <code>IRequest</code> and <code>IRequestHandler</code> in MediatR, which are responsible for implementing the Command/Query roles in CQRS. The code for this part is updated and available in this <a href=https://github.com/MoienTajik/MediatrTutorial>repository</a>.</p><hr><p><img src=/posts/2019-02-02-mediatr-part-3/FluentValidation.jpg width=270 class=post-image><div class=custom-linebreak></div></p><p>Our Command, <code>CreateCustomerCommand</code>, lacks any validation for user input. Users can call this Command with any values they like. In this part, we&rsquo;ll add validation capabilities to our Commands using the <a href=https://github.com/JeremySkinner/FluentValidation>Fluent Validation</a> library.</p><p>First, install the library using the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span>Install-Package FluentValidation.AspNetCore
</span></span></code></pre></div><div class=custom-linebreak></div><p>After adding the library, register it in your DI Container:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span>services.AddMvc()
</span></span><span style=display:flex><span>    .AddFluentValidation(cfg =&gt;
</span></span><span style=display:flex><span>        cfg.RegisterValidatorsFromAssemblyContaining&lt;Startup&gt;()
</span></span><span style=display:flex><span>    );
</span></span></code></pre></div><p><div class=custom-linebreak></div>Create a new class called <code>CreateCustomerCommandValidator</code> that inherits from Fluent Validation&rsquo;s <code>AbstractValidator</code> to define the validation logic for <code>CreateCustomerCommand</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CreateCustomerCommandValidator</span> : AbstractValidator&lt;CreateCustomerCommand&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> CreateCustomerCommandValidator()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        RuleFor(customer =&gt; customer.FirstName).NotEmpty();
</span></span><span style=display:flex><span>        RuleFor(customer =&gt; customer.LastName).NotEmpty();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>As you can see, we have checked that the <code>FirstName</code> and <code>LastName</code> properties are not empty. FluentValidation offers various validation methods, the list of which you can see <a href=https://fluentvalidation.net/built-in-validators>here</a>. Custom Validators can also be created, as shown in these <a href=https://fluentvalidation.net/custom-validators>examples</a>.</p><p>If you run the application and call the <code>CreateCustomerCommand</code> with empty fields, you&rsquo;ll immediately encounter an error, indicating that Fluent Validation has performed its validation tasks correctly.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span>Error: <span style=color:#ae81ff>400</span> - Bad Request
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;LastName&#34;</span>: [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#39;Last Name&#39; must not be empty.&#34;</span>
</span></span><span style=display:flex><span>  ],
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;FirstName&#34;</span>: [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#39;First Name&#39; must not be empty.&#34;</span>
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><div class=custom-linebreak></div><strong>*</strong> <strong>Note:</strong> All superficial validations like non-empty values, date validation, email validation, etc., must be done <strong>before</strong> Commands are handled. If validation fails, we should not enter the Command&rsquo;s Handle method. (<a href=https://enterprisecraftsmanship.com/2015/09/15/fail-fast-principle/>Fail Fast Principle</a>)</p><hr><h3 id=events>Events</h3><p><img src=/posts/2019-02-02-mediatr-part-3/PubSub.jpg width=270 class=post-image><div class=custom-linebreak></div></p><p>Suppose we want to send an email to a customer upon successful registration. Sending an email is not the responsibility of <code>CreateCustomerCommand</code>. Adding email-sending logic would violate the Single Responsibility Principle (<a href=http://principles-wiki.net/principles:single_responsibility_principle>SRP</a>).</p><p>To solve this issue, we can use events. Events notify their Subscribers. In MediatR, sending and handling Events is done via two interfaces: <code>INotification</code> and <code>INotificationHandler</code>.</p><p>Unlike Commands, which can only have one Handler, Events can have multiple handlers. This allows you not only to have a Subscriber responsible for sending emails but also another Subscriber to log the new customer information.</p><p>First, create a class named <code>CustomerCreatedEvent</code> that inherits from <code>INotification</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CustomerCreatedEvent</span> : INotification
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> CustomerCreatedEvent(<span style=color:#66d9ef>string</span> firstName, <span style=color:#66d9ef>string</span> lastName, DateTime registrationDate)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        FirstName = firstName;
</span></span><span style=display:flex><span>        LastName = lastName;
</span></span><span style=display:flex><span>        RegistrationDate = registrationDate;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string</span> FirstName { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string</span> LastName { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> DateTime RegistrationDate { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><div class=custom-linebreak></div>Next, write two handlers for this event. The first handler will be responsible for sending emails:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CustomerCreatedEmailSenderHandler</span> : INotificationHandler&lt;CustomerCreatedEvent&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Task Handle(CustomerCreatedEvent notification, CancellationToken cancellationToken)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// IEmailService.Send($&#34;Welcome {notification.FirstName} {notification.LastName} !&#34;);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Task.CompletedTask;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><div class=custom-linebreak></div>The second handler will log the newly registered customer information:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CustomerCreatedLoggerHandler</span> : INotificationHandler&lt;CustomerCreatedEvent&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>readonly</span> ILogger&lt;CustomerCreatedLoggerHandler&gt; _logger;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> CustomerCreatedLoggerHandler(ILogger&lt;CustomerCreatedLoggerHandler&gt; logger)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        _logger = logger;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Task Handle(CustomerCreatedEvent notification, CancellationToken cancellationToken)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        _logger.LogInformation(<span style=color:#e6db74>$&#34;New customer has been created at {notification.RegistrationDate}: {notification.FirstName} {notification.LastName}&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Task.CompletedTask;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><div class=custom-linebreak></div>Finally, you just need to modify the handle method inside <code>CreateCustomerCommandHandler</code> that we created in the <a href=https://moien.dev/posts/2019-01-27-mediatr-part-2>previous post</a> and use the <code>Publish</code> method from <code>IMediator</code> interface to raise this event:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CreateCustomerCommandHandler</span> : IRequestHandler&lt;CreateCustomerCommand, CustomerDto&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>readonly</span> ApplicationDbContext _context;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>readonly</span> IMapper _mapper;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>readonly</span> IMediator _mediator;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> CreateCustomerCommandHandler(ApplicationDbContext context,
</span></span><span style=display:flex><span>        IMapper mapper,
</span></span><span style=display:flex><span>        IMediator mediator)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        _context = context;
</span></span><span style=display:flex><span>        _mapper = mapper;
</span></span><span style=display:flex><span>        _mediator = mediator;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task&lt;CustomerDto&gt; Handle(CreateCustomerCommand createCustomerCommand, CancellationToken cancellationToken)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        Customer customer = _mapper.Map&lt;Customer&gt;(createCustomerCommand);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> _context.Customers.AddAsync(customer, cancellationToken);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> _context.SaveChangesAsync(cancellationToken);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Raising Event ...</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> _mediator.Publish(<span style=color:#66d9ef>new</span> CustomerCreatedEvent(customer.FirstName, customer.LastName, customer.RegistrationDate), cancellationToken);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> _mapper.Map&lt;CustomerDto&gt;(customer);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><div class=custom-linebreak></div>Run the application and set breakpoints on both NotificationHandlers. If you call <code>/api/customers</code> to create a new customer, you&rsquo;ll see both of your handlers get raised, and you&rsquo;ll see the customer information logged in the console using our log handler.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span>info: MediatrTutorial.Features.Customer.Events.CustomerCreated.CustomerCreatedLoggerHandler[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>      New customer has been created at <span style=color:#ae81ff>2</span>/<span style=color:#ae81ff>1</span>/<span style=color:#ae81ff>2019</span> <span style=color:#ae81ff>11</span>:<span style=color:#ae81ff>40</span>:<span style=color:#ae81ff>48</span> PM: Moien Tajik
</span></span></code></pre></div><hr><p><strong>*</strong> <strong>Note:</strong> In this part of the tutorial, we used a Notification for logging purposes. If the number of Commands in our application increases, we&rsquo;ll have to create a new <code>INotification</code> and <code>INotificationHandler</code> for each Command, even though their logic will be very similar.</p><p>In the next article, we&rsquo;ll eliminate these repetitive parts using MediatR Behaviors, which implement <em>Aspect-Oriented Programming (AOP)</em>.</p></div><hr><div class=footer><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script type=text/javascript>hljs.configure({languages:[]}),hljs.initHighlightingOnLoad()</script><h2>Comments</h2><div id=disqus_thread></div><script type=text/javascript>(function(){if(location.hostname==="localhost"||location.hostname==="127.0.0.1"||location.hostname==="")return;var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="moientajik",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></div></body></html>