<!doctype html><html lang=en class="wf-firasans-n4-active wf-active"><head><link href=http://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=generator content="Hugo 0.121.0"><title>Implementing CQRS with MediatR - Part 2 &#183; Moien Tajik</title>
<meta content="Moien Tajik" property="og:site_name"><meta content="Implementing CQRS with MediatR - Part 2 - Moien Tajik" property="og:title"><meta content="This series explores the implementation of the CQRS design pattern using the MediatR library." property="og:description"><meta content="/Hollywood.jpg" property="og:image"><link href="https://fonts.googleapis.com/css?family=Fira+Sans:300,300i,400,400i|Roboto+Mono:300,300i,400,400i" rel=stylesheet><style media=print>.sidebar{display:none!important}.container,.content{width:100%;float:none;display:initial;margin:0 auto}.container{padding-left:1rem;padding-right:1rem}</style><link rel=stylesheet href=/css/poole.css><link rel=stylesheet href=/css/hyde.css><link rel=stylesheet href=/css/custom.css><script defer src=https://use.fontawesome.com/releases/v5.0.13/js/all.js integrity=sha384-xymdQtn1n3lH2wcu0qhcdaOpQwyoarkgLVxC/wZ5q7h9gHtxICrpcaSUfygqZGOe crossorigin=anonymous></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body class=theme-base-te><div class=sidebar><div class="container text-center"><div class="sidebar-about text-center"><img src=/img/Moien%20Tajik.png alt="Moien Tajik's Image" class="img-circle headshot center">
<a href=/ class=no-decoration><h1 class=brand>Moien Tajik</h1></a><p class=lead>Principal Software Engineer</p></div><div><ul class=sidebar-nav><li><a href=/><span>Home</span></a></li><li><a href=/posts/><span>Posts</span></a></li><li><a href=/tags/><span>Tags</span></a></li></li></ul></div><p><section class="row text-center"><a href=https://twitter.com/MoienTajik><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a>
&nbsp;<a href=https://github.com/MoienTajik><i class="fab fa-github fa-lg" aria-hidden=true></i></a>
&nbsp;<a href=https://linkedin.com/in/MoienTajik><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a>
&nbsp;<a href=https://stackoverflow.com/story/moientajik><i class="fab fa-stack-overflow fa-lg" aria-hidden=true></i></a>
&nbsp;<a href=https://medium.com/@MoienTajik><i class="fab fa-medium fa-lg" aria-hidden=true></i></a>
&nbsp;<a href=mailto:moientajik@hotmail.com><i class="fas fa-at fa-lg" aria-hidden=true></i></a></section></p><p class=copyright>&copy; 2024 Moien Tajik</br><a href=https://creativecommons.org/licenses/by/4.0>All rights reserved</a></p></div><div></div></div><div class="content container"><div class=post><h1 class=postTitle>Implementing CQRS with MediatR - Part 2</h1><div class="col-sm-12 col-md-12"><span class="text-left post-date meta"><i class="fas fa-calendar-alt"></i> <span class=subtitle>Publish Date: Jan 27, 2019</span><br><i class="fas fa-tags"></i>
Tags:
<a class=meta href=/tags/cqrs>cqrs</a>
,
<a class=meta href=/tags/designpatterns>designpatterns</a>
,
<a class=meta href=/tags/eventsourcing>eventsourcing</a>
,
<a class=meta href=/tags/mediator>mediator</a>
,
<a class=meta href=/tags/mediatr>mediatr</a><br></span></div><hr><p>You can find the source-code for this section of the article in <a href=https://github.com/MoienTajik/MediatrTutorial>this GitHub repository</a>.</p><hr><h4 id=installation-and-setup><strong>Installation and Setup</strong></h4><p>Initially, we create a new ASP.NET Core API project and install the MediatR package using the NuGet Package Manager:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span>Install-Package MediatR.Extensions.Microsoft.DependencyInjection
</span></span></code></pre></div><p><div class=custom-linebreak></div>After installing, add this code to the ConfigureServices method in the Startup.cs file of your project to register the MediatR dependencies in your DI Container:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> ConfigureServices(IServiceCollection services)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    services.AddMediatR(cfg =&gt;
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        cfg.RegisterServicesFromAssembly(Assembly.GetExecutingAssembly());
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><div class=custom-linebreak></div><strong>*</strong> If you are using other DI Containers, you can register MediatR in your preferred container using the instructions from <a href=https://github.com/jbogard/MediatR/wiki#setting-up>this</a> link.</p><hr><h4 id=irequest>IRequest</h4><p>As mentioned in the <a href=https://moien.dev/posts/2019-01-21-mediatr-part-1>previous post</a>, in CQRS, the methods of the application are divided into Command and Query sections. In MediatR, an interface named IRequest has been created. All our Command/Query classes, which request the execution of a task, will inherit from this interface.</p><p>The reason for naming this interface <strong>IRequest</strong> is that we are creating a request to add a new customer, and another part of the application will be responsible for <strong>responding</strong> to this request.</p><p><code>IRequest</code> has two overloads: generic and non-generic.
The non-generic implementation is for requests that do not have a return response (usually commands), and we do not expect any response from them. The generic implementation specifies the type of response that will be returned after processing the request.</p><p>For instance, we intend to create a new customer in our application. The <code>Customer</code> class is defined as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Customer</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> Id { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string</span> FirstName { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string</span> LastName { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> DateTimeOffset RegistrationDate { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And the corresponding DTO is defined like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CustomerDto</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> Id { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string</span> FirstName { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string</span> LastName { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string</span> RegistrationDate { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><div class=custom-linebreak></div>Adding a customer is a <strong>Command</strong> because it adds a new record to the database and changes the <strong>state</strong> of the application. We create a new class named <code>CreateCustomerCommand</code>, inherit from IRequest, and set the return response type to <code>CustomerDto</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CreateCustomerCommand</span> : IRequest&lt;CustomerDto&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> CreateCustomerCommand(<span style=color:#66d9ef>string</span> firstName, <span style=color:#66d9ef>string</span> lastName)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        FirstName = firstName;
</span></span><span style=display:flex><span>        LastName = lastName;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string</span> FirstName { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string</span> LastName { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><div class=custom-linebreak></div>The <code>CreateCustomerCommand</code> specifies its requirements through the constructor. To create a customer, the minimum required information is the <code>Firstname</code> and <code>Lastname</code>, and after passing the necessary values to the constructor of this class, the values are immutable due to being get-only.</p><p>Here, the concept of <a href=https://www.yegor256.com/2014/06/09/objects-should-be-immutable.html>immutability</a> is fully observed.</p><img src=/posts/2019-01-27-mediatr-part-2/immutability.jpg width=600 class=post-image><hr><h4 id=irequesthandler>IRequestHandler</h4><p>Every <code>IRequest</code> requires a handler to process it. In MediatR, the classes responsible for processing a <code>IRequest</code> inherit from the <code>IRequestHandler</code> interface and implement its <code>Handle()</code> method.</p><p>Continuing from the previous example, we create a class named <code>CreateCustomerCommandHandler</code>, inherit from <code>IRequestHandler</code>, and implement the logic for adding a customer to the database:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CreateCustomerCommandHandler</span> : IRequestHandler&lt;CreateCustomerCommand, CustomerDto&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>readonly</span> ApplicationDbContext _context;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>readonly</span> IMapper _mapper;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> CreateCustomerCommandHandler(ApplicationDbContext context, IMapper mapper)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        _context = context;
</span></span><span style=display:flex><span>        _mapper = mapper;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task&lt;CustomerDto&gt; Handle(CreateCustomerCommand createCustomerCommand, CancellationToken cancellationToken)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        Customer customer = _mapper.Map&lt;Customer&gt;(createCustomerCommand);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> _context.Customers.AddAsync(customer, cancellationToken);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> _context.SaveChangesAsync(cancellationToken);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> _mapper.Map&lt;CustomerDto&gt;(customer);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The first generic parameter of <code>IRequestHandler</code> is the request itself, and the second parameter is the class that will be returned as the response after processing.</p><p>As you can see in this Handler, we use the Entity Framework&rsquo;s <em>DbContext</em> to register information in the database and AutoMapper&rsquo;s <em>IMapper</em> to map the <code>CreateCustomerCommand</code> to <code>Customer</code>.</p><p>Our AutoMapper profile settings are configured to set the Customer&rsquo;s <code>RegistrationDate</code> to the current time during the <code>CreateCustomerCommand</code> mapping, and to display the <code>RegistrationDat</code>e in a user-friendly format when mapping Customer to CustomerDto:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DomainProfile</span> : Profile
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> DomainProfile()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        CreateMap&lt;CreateCustomerCommand, Customer&gt;()
</span></span><span style=display:flex><span>            .ForMember(c =&gt; c.RegistrationDate, opt =&gt;
</span></span><span style=display:flex><span>                opt.MapFrom(_ =&gt; DateTimeOffset.Now));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        CreateMap&lt;Customer, CustomerDto&gt;()
</span></span><span style=display:flex><span>            .ForMember(cd =&gt; cd.RegistrationDate, opt =&gt;
</span></span><span style=display:flex><span>                opt.MapFrom(c =&gt; c.RegistrationDate.ToShortDateString()));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><div class=custom-linebreak></div>Finally, by injecting the <code>IMediator</code> interface into our controller and sending a POST request to this action, we issue the customer creation request through the <code>Send</code> method:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#a6e22e>[HttpPost]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task&lt;IActionResult&gt; CreateCustomer([FromBody] CreateCustomerCommand createCustomerCommand)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    CustomerDto customer = <span style=color:#66d9ef>await</span> _mediator.Send(createCustomerCommand);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> CreatedAtAction(nameof(GetCustomerById), <span style=color:#66d9ef>new</span> { customerId = customer.Id }, customer);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><div class=custom-linebreak></div>As you can see, here we have only sent the <strong>request</strong>, and the responsibility of finding the handler of this request is undertaken by the MediatR framework, and we have not directly called our handler anywhere (<a href=http://matthewtmead.com/blog/hollywood-principle-dont-call-us-well-call-you-4/>Hollywood Principle: Don&rsquo;t Call Us, We Call You</a>).</p><img src=/posts/2019-01-27-mediatr-part-2/Hollywood.jpg width=300 class=post-image><p><div class=custom-linebreak></div>The implementation of a <em>Query</em> is exactly similar to a <em>Command</em>, and an example of it exists in the <a href=https://github.com/MoienTajik/MediatrTutorial>repository</a> mentioned at the beginning of the article.
In addition to the <code>Send</code> method, the IMediator interface has another method called <code>Publish</code>, which is responsible for raising <strong>events</strong>, which we will use in later articles.</p><hr><p><strong>A few points:</strong></p><p>1- In naming <strong>Commands</strong>, the word <em>Command</em> is mentioned at the end of their name: <code>CreateCustomerCommand</code></p><p>2- In naming <strong>Queries</strong>, the word <em>Query</em> is mentioned at the end of their name: <code>GetCustomerByIdQuery</code></p><p>3- In naming <strong>Handlers</strong>, we use the combination of <em>Command/Query</em> + <em>Handler</em>: <code>CreateCustomerCommandHandler</code>, <code>GetCustomerByIdQueryHandler</code></p><p>4- In this section, our requests entered their handlers without any validation, which is not the use-case in most applications. In the next section, we will automatically validate the parameters of our requests using <a href=https://github.com/JeremySkinner/FluentValidation>Fluent-Validation</a>.</p></div><hr><div class=footer><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script type=text/javascript>hljs.configure({languages:[]}),hljs.initHighlightingOnLoad()</script><h2>Comments</h2><div id=disqus_thread></div><script type=text/javascript>(function(){if(location.hostname==="localhost"||location.hostname==="127.0.0.1"||location.hostname==="")return;var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="moientajik",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></div></body></html>