<!doctype html><html lang=en class="wf-firasans-n4-active wf-active"><head><link href=http://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=generator content="Hugo 0.121.0"><title>Implementing CQRS with MediatR - Part 5 &#183; Moien Tajik</title>
<meta content="Moien Tajik" property="og:site_name"><meta content="Implementing CQRS with MediatR - Part 5 - Moien Tajik" property="og:title"><meta content="This series explores the implementation of the CQRS design pattern using the MediatR library." property="og:description"><meta content="/EventStore.png" property="og:image"><link href="https://fonts.googleapis.com/css?family=Fira+Sans:300,300i,400,400i|Roboto+Mono:300,300i,400,400i" rel=stylesheet><style media=print>.sidebar{display:none!important}.container,.content{width:100%;float:none;display:initial;margin:0 auto}.container{padding-left:1rem;padding-right:1rem}</style><link rel=stylesheet href=/css/poole.css><link rel=stylesheet href=/css/hyde.css><link rel=stylesheet href=/css/custom.css><script defer src=https://use.fontawesome.com/releases/v5.0.13/js/all.js integrity=sha384-xymdQtn1n3lH2wcu0qhcdaOpQwyoarkgLVxC/wZ5q7h9gHtxICrpcaSUfygqZGOe crossorigin=anonymous></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body class=theme-base-te><div class=sidebar><div class="container text-center"><div class="sidebar-about text-center"><img src=/img/Moien%20Tajik.png alt="Moien Tajik's Image" class="img-circle headshot center">
<a href=/ class=no-decoration><h1 class=brand>Moien Tajik</h1></a><p class=lead>Principal Software Engineer</p></div><div><ul class=sidebar-nav><li><a href=/><span>Home</span></a></li><li><a href=/posts/><span>Posts</span></a></li><li><a href=/tags/><span>Tags</span></a></li></li></ul></div><p><section class="row text-center"><a href=https://twitter.com/MoienTajik><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a>
&nbsp;<a href=https://github.com/MoienTajik><i class="fab fa-github fa-lg" aria-hidden=true></i></a>
&nbsp;<a href=https://linkedin.com/in/MoienTajik><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a>
&nbsp;<a href=https://stackoverflow.com/story/moientajik><i class="fab fa-stack-overflow fa-lg" aria-hidden=true></i></a>
&nbsp;<a href=https://medium.com/@MoienTajik><i class="fab fa-medium fa-lg" aria-hidden=true></i></a>
&nbsp;<a href=mailto:moientajik@hotmail.com><i class="fas fa-at fa-lg" aria-hidden=true></i></a></section></p><p class=copyright>&copy; 2024 Moien Tajik</br><a href=https://creativecommons.org/licenses/by/4.0>All rights reserved</a></p></div><div></div></div><div class="content container"><div class=post><h1 class=postTitle>Implementing CQRS with MediatR - Part 5</h1><div class="col-sm-12 col-md-12"><span class="text-left post-date meta"><i class="fas fa-calendar-alt"></i> <span class=subtitle>Publish Date: Feb 24, 2019</span><br><i class="fas fa-tags"></i>
Tags:
<a class=meta href=/tags/cqrs>cqrs</a>
,
<a class=meta href=/tags/designpatterns>designpatterns</a>
,
<a class=meta href=/tags/eventsourcing>eventsourcing</a>
,
<a class=meta href=/tags/mediator>mediator</a>
,
<a class=meta href=/tags/mediatr>mediatr</a><br></span></div><hr><p>The code for this section has been updated and can be accessed from this <a href=https://github.com/MoienTajik/MediatrTutorial>repository</a>.</p><hr><h2 id=event-sourcing>Event Sourcing</h2><p>In this part, we intend to store our Command information in an append-only database after processing. By utilizing this <a href=https://martinfowler.com/eaaDev/EventSourcing.html>method</a>, we can understand at a <strong>specific date</strong>, with what inputs (request), what output (response) has been returned by the program at that moment.</p><p><div class=custom-linebreak></div><img src=/posts/2019-02-24-mediatr-part-5/EventStore.png width class=post-image><div class=custom-linebreak></div></p><p>To implement Event Sourcing, we will use the <a href=https://eventstore.org/>EventStore</a> database, the source of which is also available on <a href=https://github.com/EventStore/EventStore>GitHub</a>. Note that you can use other databases like Elasticsearch, Redis, etc., for your Event Store database and are not limited to EventStore.</p><p>For setting up the <strong>EventStore</strong> in this section, we will use Docker. Using the command below, we pull and run EventStore image from the <a href=https://hub.docker.com/r/eventstore/eventstore>Docker Hub</a>, and expose ports <code>2113</code> and <code>1113</code> so that we can use them in our application:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span>docker run --name eventstore-node -d -p <span style=color:#ae81ff>2113</span>:<span style=color:#ae81ff>2113</span> -p <span style=color:#ae81ff>1113</span>:<span style=color:#ae81ff>1113</span> eventstore/eventstore
</span></span></code></pre></div><p>EventStore has an admin panel accessible through <a href=http://localhost:2113>http://localhost:2113</a>. The default username is <code>admin</code> and the password is <code>changeit</code>.</p><p>After logging into the admin panel, you will encounter such a dashboard, indicating that EventStore has been successfully run:
<img src=/posts/2019-02-24-mediatr-part-5/EventStore-Panel.png width class=post-image></p><hr><p>To use EventStore in our application, like other packages, we install its nuget package from <a href=https://www.nuget.org/packages/EventStore.Client>NuGet</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span>Install-Package EventStore.Client
</span></span></code></pre></div><p><div class=custom-linebreak></div>Then we create a class named <code>EventStoreDbContext</code> and place the logic of connecting to EventStore within it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EventStoreDbContext</span> : IEventStoreDbContext
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task&lt;IEventStoreConnection&gt; GetConnection()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        IEventStoreConnection connection = EventStoreConnection.Create(
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> IPEndPoint(IPAddress.Loopback, <span style=color:#ae81ff>1113</span>),
</span></span><span style=display:flex><span>            nameof(MediatrTutorial));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> connection.ConnectAsync();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> connection;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task AppendToStreamAsync(<span style=color:#66d9ef>params</span> EventData[] events)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>string</span> appName = nameof(MediatrTutorial);
</span></span><span style=display:flex><span>        IEventStoreConnection connection = <span style=color:#66d9ef>await</span> GetConnection();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> connection.AppendToStreamAsync(appName, ExpectedVersion.Any, events);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>As you see, we connect to EventStore using port <code>1113</code>, which we exposed earlier using Docker. Also, for our <code>AppendToStreamAsync</code> method in EventStore, we have written a <a href=https://www.dofactory.com/net/facade-design-pattern>Facade</a> which has made working with it easier for us.</p><p>Considering that EventStore has stated in its <a href=https://eventstore.org/docs/dotnet-api/index.html#eventstoreconnection>Documentation</a> that it is thread-safe, we register <code>EventStoreDbContext</code> as singleton in our DI container, and throughout the application lifespan, we will have an instance of it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span>services.AddSingleton&lt;IEventStoreDbContext, EventStoreDbContext&gt;();
</span></span></code></pre></div><p>We intend to store the requests which are of type <code>Command</code>, along with their responses, inside EventStore. To distinguish whether a request is a <em>Query</em> or <em>Command</em>, we will use their names. As we mentioned in previous sections, commands should be suffixed with &ldquo;<strong>Command</strong>&rdquo; in their name.</p><p>This is a Convention in our program that must be observed. (<a href=https://www.danylkoweb.com/Blog/aspnet-mvc-convention-over-configuration-BU>Convention over Configuration</a>)</p><img src=/posts/2019-02-24-mediatr-part-5/CoC.png width=300px class=post-image><hr><p>Like previous Behaviors, we create a new behavior named <code>EventLoggerBehavior</code>, inherit from <code>IPipelineBehavior</code>, and inject our <code>EventStoreDbContext</code> into it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EventLoggerBehavior</span>&lt;TRequest, TResponse&gt; :
</span></span><span style=display:flex><span>   IPipelineBehavior&lt;TRequest, TResponse&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>readonly</span> IEventStoreDbContext _eventStoreDbContext;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> EventLoggerBehavior(IEventStoreDbContext eventStoreDbContext)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        _eventStoreDbContext = eventStoreDbContext;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task&lt;TResponse&gt; Handle(TRequest request, CancellationToken cancellationToken, RequestHandlerDelegate&lt;TResponse&gt; next)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        TResponse response = <span style=color:#66d9ef>await</span> next();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>string</span> requestName = request.ToString();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Commands convention</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (requestName.EndsWith(<span style=color:#e6db74>&#34;Command&#34;</span>))
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            Type requestType = request.GetType();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>string</span> commandName = requestType.Name;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>var</span> data = <span style=color:#66d9ef>new</span> Dictionary&lt;<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>object</span>&gt;
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;request&#34;</span>, request
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;response&#34;</span>, response
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>string</span> jsonData = JsonConvert.SerializeObject(data);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>byte</span>[] dataBytes = Encoding.UTF8.GetBytes(jsonData);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            EventData eventData = <span style=color:#66d9ef>new</span> EventData(eventId: Guid.NewGuid(),
</span></span><span style=display:flex><span>                type: commandName,
</span></span><span style=display:flex><span>                isJson: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>                data: dataBytes,
</span></span><span style=display:flex><span>                metadata: <span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>await</span> _eventStoreDbContext.AppendToStreamAsync(eventData);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> response;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><div class=custom-linebreak></div>Using this behavior, we only store those requests which are <strong>Commands</strong> and change the program state, inside EventStore. Now, it’s enough to register this behavior to our DI container:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span>services.AddScoped(<span style=color:#66d9ef>typeof</span>(IPipelineBehavior&lt;,&gt;), <span style=color:#66d9ef>typeof</span>(EventLoggerBehavior&lt;,&gt;));
</span></span></code></pre></div><p><div class=custom-linebreak></div>If you run the program and call one of the commands like <code>CreateCustomerCommand</code>, using <code>POST api/customers</code>, your request and response along with the <code>type</code> of that Command and the <code>DateTime</code> when this request occurred, will be stored in EventStore, which can be viewed in the EventStore admin panel, under the <em>Stream Browser</em> tab:</p><p><img src=/posts/2019-02-24-mediatr-part-5/EventStore-Panel-Stream.png width=300px class=post-image><div class=custom-linebreak></div></p><p>The naming of this section as Stream, is due to the fact that we have a <strong>history</strong> of events occurred in the system, through which we can understand the current state and <strong>how</strong> we arrived at this state.</p></div><hr><div class=footer><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script type=text/javascript>hljs.configure({languages:[]}),hljs.initHighlightingOnLoad()</script><h2>Comments</h2><div id=disqus_thread></div><script type=text/javascript>(function(){if(location.hostname==="localhost"||location.hostname==="127.0.0.1"||location.hostname==="")return;var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="moientajik",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></div></body></html>